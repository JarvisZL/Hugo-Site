---
author: "Lingyu Zhang"
author_link: "https://jarviszly.com"
title: "文件系统API"
date: 2020-06-23T22:16:46+08:00
lastmod: 2020-06-23T22:16:46+08:00
draft: false
description: ""
show_in_homepage: true
description_as_summary: false
license: ""

tags: []
categories: [操作系统]

featured_image: ""
featured_image_preview: ""

comment: true
toc: true
auto_collapse_toc: true
math: true
---

## 为什么需要文件系统
- 应用程序直接通过设备驱动程序访问存储设备不合适
  - 多个应用程序并发访问存储设备
  - 一个有Bug的应用程序可能直接损坏整个存储设备。
- 所以需要在这个基础上再添加一层抽象层，将一个磁盘抽象成多个虚拟磁盘。
- 文件系统就是对存储设备的虚拟化。
  - 磁盘(I/O设备)是一个可读可写的字节序列
  - 虚拟磁盘是一个动态的可读可写的字节序列
- 从实现方面来看，文件系统就是在持久化存储设备上的数据结构。
  - 规定了数据的存储方式
  - 提供了对数据结构进行的一些操作

## 文件API

### lseek, mmap, ftruncate
- mmap
  - open一个文件后可以使用mmap(MAP\_SHARED)将文件映射到地址空间，使用mmap(MAP\_PRIVATE)创建一个文件的copy-on-write的副本
- 问题在于：如果我们使用mmap映射的长度超过文件大小，然后访问了超过文件大小的内容，会发生什么
- mmap手册已经说明：会返回一个SIGBUS的信号 
- ftruncate可以改变一个文件的大小，lseek可以改变读写文件偏移量，那么这三个API可能会相互影响。
  - 比如 mmap 2MB, lseek 3MB, ftruncate 1MB 那么之后读写在哪里？

### 偏移量管理
- 从上面一个例子可以知道偏移量管理十分重要。
  - 当进程fork的时候，对于文件描述符是浅拷贝，也就是说父子进程共享一个偏移量。
  - 当使用dup的时候，对于文件描述符也是浅拷贝。
  - 使用open的时候，获得一个独立的offset.

## 文件系统API-管理众多虚拟磁盘

### 目录管理
- mkdir, rmdir

### 硬链接和软链接
- 硬链接
  - 需求：有的时候需要一个文件被多个目录引用，但不像要不必要的拷贝
  - ln filename newfilename
  - 只允许文件对文件的硬链接，不允许目录的硬链接也不允许跨文件系统的硬链接。
  - 而实际上对于Linux的文件系统来说，其树状结构的每一个叶节点并不是想FAT文件系统一样就是一个文件，而是一个指向某个虚拟磁盘的指针，于是，维护好每个虚拟磁盘的引用计数就能很好地实现硬链接，查看rm的系统调用可以发现使用的是unlink.
  - 使用ls -li可以看到硬链接的文件的编号是一样的。
- 软(符号链接)连接
  - 需求：可以实现目录的链接和跨文件系统的链接。
  - 其并不是像硬链接一样只是多了一个引用计数，而是创建了另一个文件，而该文件中描述了要跳转到其链接目标处去解析
    - ln -S a.txt b.txt
    - 那么b.txt文件内实际上记录的是跳转去解析a.txt文件.
  - 由于软链接的加入，使得一些情况复杂起来，比如可以在用一个文件软链接当前目录，于是就可以使得当前目录不是唯一表示，而对于很多会递归解析软链接的命令就需要额外考虑遇到环路时的情况。
  - 使用ls -li会发现软链接的文件的编号不一样

### 挂载mount
- Unix允许任意一个目录都可以作为另一个文件系统的根。
- 通过mount命令可以将一个文件系统挂载到当前文件系统的某个目录下，umount可以取消挂载。
  - 比如/proc挂载了procfs, /sys挂载了sysfs等
- 这样的机制使得系统中可以有各种各样的文件系统。
- 一般来说，挂载的文件系统实现在一个设备上(比如一块磁盘)，挂载会将文件系统和设备都挂载到指定目录下，但是同样也可以挂载镜像文件。
- 当挂载镜像文件的时候，系统会为其分配一个loopback device(回环设备)，会将这个回环设备和该镜像文件绑定，之后所有对该回环设备的读写都会被翻译成对镜像文件的操作。